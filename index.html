<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente Secreto: La Fortaleza del Phishing</title>
  <style>
    :root{
      --bg:#0b1020;            /* fondo oscuro futurista */
      --panel:#131b3a;         /* paneles azules */
      --accent:#00e5ff;        /* cian hologr√°fico */
      --accent2:#7cff6b;       /* verde seguro */
      --danger:#ff3b3b;        /* rojo alarma */
      --gold:#ffd54a;          /* oro del diamante */
      --text:#eaf4ff;
      --muted:#9ab3c7;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden;}
    h1,h2,h3{margin:.2rem 0}
    #game{display:grid;grid-template-rows:auto 1fr auto;gap:.5rem;height:100%;padding:10px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#15235a,#0d1330);border:1px solid #22306b;border-radius:14px;padding:8px 12px;box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 30px rgba(0,229,255,.08)}
    .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:rgba(0,229,255,.08);border:1px solid #1b2b66;border-radius:999px;padding:6px 10px;font-weight:700}
    .chip small{opacity:.8;font-weight:600}
    .chip .dot{width:10px;height:10px;border-radius:50%}
    .chip.score .dot{background:var(--accent2)}
    .chip.stealth .dot{background:#8a7cff}
    .chip.alerts .dot{background:var(--danger)}
    .btn{background:linear-gradient(180deg,#0fe,#0acfdc);color:#00131a;border:none;border-radius:999px;padding:8px 14px;font-weight:900;letter-spacing:.3px;cursor:pointer;box-shadow:0 8px 24px rgba(0,229,255,.25);transition:transform .15s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.98)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}

    #viewport{position:relative;overflow:hidden;border-radius:16px;background:radial-gradient(1200px 800px at 70% 10%, #16224f 0%, var(--bg) 60%);border:2px solid #1a275f;box-shadow:inset 0 0 50px rgba(0,229,255,.08);transition: box-shadow .2s ease, border-color .2s ease}
    #arena{position:absolute;inset:0;}

    @keyframes pulse { 0%, 100% { box-shadow: 0 0 14px rgba(0,229,255,.7); } 50% { box-shadow: 0 0 24px 4px rgba(0,229,255,1); } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    @keyframes shake { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-5px)} 20%,40%,60%,80%{transform:translateX(5px)} }
    .shake{animation:shake .3s ease-in-out;}
    .pop { display: inline-block; animation: pop .3s ease; }

    .tile{position:absolute;border-radius:8px;display:flex;align-items:center;justify-content:center;text-align:center;font-weight:800;padding:4px 6px; transition: opacity .3s ease, transform .3s ease;}
    .player{width:36px;height:36px;background:conic-gradient(from 0deg,#00e5ff,#7a7cff,#00e5ff);border:2px solid #baf3ff;border-radius:10px;animation: pulse 2.5s ease-in-out infinite;}
    .player:after{content:"";position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:10px;height:10px;border-radius:50%;background:#fff}
    .alarm{background:linear-gradient(180deg,#ff7070,#ff3b3b);border:2px solid #ffb3b3;color:#2c0000;box-shadow:0 0 18px rgba(255,59,59,.75);}
    .safe{background:linear-gradient(180deg,#b7ffb0,#59ff48);border:2px solid #e1ffe0;color:#083300;box-shadow:0 0 18px rgba(124,255,107,.7);}
    .alarm,.safe{padding:6px 8px;font-size:12px; line-height: 1.2;}
    .gate{background:linear-gradient(180deg,#0d8a9b,#064b53);border:2px dashed #4beaff;color:#bff7ff}
    .switch{background:linear-gradient(180deg,#ffe27a,#ffc300);border:2px solid #fff1a3;color:#3b2d00;box-shadow:0 0 18px rgba(255,213,74,.6); cursor:pointer;}
    .diamond{background:radial-gradient(circle at 20% 20%, #fff, #a8f3ff 40%, #00e5ff 70%, transparent 71%), linear-gradient(135deg,#e1fbff,#00e5ff);border:2px solid #bdf4ff;box-shadow:0 0 22px rgba(0,229,255,.9);width:40px;height:40px;border-radius:8px}

    .panel{background:linear-gradient(180deg,#17265d,#0e173a);border:1px solid #263882;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.45), inset 0 0 40px rgba(0,229,255,.06);padding:16px}
    #briefing,#passwordLab,#endScreen{position:fixed;inset:0;background:rgba(7,10,25,.6);display:flex;align-items:center;justify-content:center;z-index:15;opacity:0;visibility:hidden;transition:opacity .4s ease, visibility .4s ease;}
    #briefing.visible, #passwordLab.visible, #endScreen.visible { opacity:1; visibility:visible; }
    #briefing.visible .modal, #passwordLab.visible .modal, #endScreen.visible .modal { transform: scale(1) translateY(0); }
    .modal{max-width:980px;width:clamp(320px,92vw,980px);transform: scale(0.95) translateY(20px); transition: transform .4s ease;}
    .jefa{display:flex;gap:14px;align-items:flex-start}
    .avatar{min-width:72px;height:72px;border-radius:16px;background:conic-gradient(from 220deg,#00e5ff,#7cff6b,#00e5ff);box-shadow:0 4px 16px rgba(0,229,255,.4);position:relative}
    .avatar:after{content:"üéß";position:absolute;right:-6px;top:-10px;font-size:28px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.6))}
    .voiceRow{display:flex;gap:8px;align-items:center;margin-top:6px}

    #lab{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    #pool,.drop{min-height:220px;border:2px dashed #2c4bd6;border-radius:12px;padding:10px;background:rgba(0,229,255,.06)}
    #pool{display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}
    .token{user-select:none;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:linear-gradient(180deg,#20336f,#17265d);border:1px solid #2d4bd2;box-shadow:0 6px 14px rgba(0,0,0,.35);font-weight:900;cursor:grab;transition:transform .2s ease, box-shadow .2s ease}
    .token:active{cursor:grabbing;transform:scale(1.15);box-shadow:0 8px 20px rgba(0,0,0,.5);}
    .slot{display:inline-flex;min-width:30px;height:38px;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.06);border:1px dashed #3b58da;margin:2px;padding:2px 6px;animation: pop 0.2s ease-out;}
    .req{display:flex;flex-wrap:wrap;gap:6px}
    .req .r{padding:6px 8px;border-radius:999px;background:rgba(124,255,107,.1);border:1px solid rgba(124,255,107,.4);font-size:12px;transition:background .3s, border-color .3s}
    .req .bad{background:rgba(255,59,59,.12);border-color:rgba(255,59,59,.4)}

    #controls{position:fixed;left:10px;bottom:10px;z-index:12;display:grid;grid-template-columns:60px 60px 60px;grid-template-rows:60px 60px 60px;gap:6px;opacity:.9}
    .pad{background:linear-gradient(180deg,#22346b,#1a275f);border:1px solid #2b3f84;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 12px 24px rgba(0,0,0,.35);-webkit-tap-highlight-color: transparent;}
    .pad:active{transform:translateY(2px)}
    .pad span{font-size:18px}
    .pad.blank{background:transparent;border:none;box-shadow:none}

    footer{display:flex;gap:10px;align-items:center;justify-content:space-between;opacity:.9}
    footer small{color:var(--muted)}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
<div id="game">
  <header>
    <div class="hud">
      <div class="chip score" id="scoreChip"><div class="dot"></div><span>Puntos: <span id="score">0</span></span></div>
      <div class="chip stealth" id="stealthChip"><div class="dot"></div><span>Sigilo: <span id="stealth">100</span></span></div>
      <div class="chip alerts" id="alertsChip"><div class="dot"></div><span>Alarmas: <span id="alerts">0</span>/5</span></div>
      <div class="chip"><span>Fase: <strong id="phase">Briefing</strong></span></div>
    </div>
    <div class="hud">
      <button class="btn" id="speakBtn" title="Voz en off">üîä Voz</button>
      <button class="btn" id="restartBtn" title="Reiniciar">‚Üª Reiniciar</button>
    </div>
  </header>
  <main id="viewport" class="panel" aria-live="polite"><div id="arena"></div></main>
  <footer>
    <div><strong>Controles:</strong> Flechas / WASD o pad t√°ctil. Toca/Click en puertas/interruptores.</div>
    <small>Agente Secreto: La Fortaleza del Phishing ‚Äî Educaci√≥n en Ciberseguridad (8‚Äì9 a√±os)</small>
  </footer>
</div>
<div id="briefing">
  <div class="modal panel">
    <h2>üî∑ BRIEFING: Operaci√≥n ‚ÄúDiamante de la Informaci√≥n‚Äù</h2>
    <div class="jefa">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <p><strong>Jefa de la Agencia:</strong> Agente, esta fortaleza est√° plagada de <span style="color:var(--danger);font-weight:900">anuncios-trampa</span>. Lucen brillantes, prometen cosas locas y quieren que hagas clic sin pensar.</p>
        <p>Tu misi√≥n: esquivar las alarmas rojas, recoger <span style="color:var(--accent2);font-weight:900">anuncios seguros</span> de la Agencia, y abrir cerraduras con <strong>contrase√±as fuertes</strong>:</p>
        <ul>
          <li>M√≠nimo 8 caracteres</li>
          <li>Al menos una <strong>May√∫scula</strong>, un <strong>n√∫mero</strong> y un <strong>s√≠mbolo</strong></li>
          <li>Evita palabras obvias como <em>password</em> o tu nombre</li>
        </ul>
        <div class="voiceRow">
          <button class="btn" id="startBtn">Infiltrarse</button>
          <button class="btn" id="briefSpeak">üîä Reproducir Voz</button>
        </div>
        <p style="color:var(--muted)"><small>Sugerencia: Si ves mensajes como ‚Äú¬°√öltima oportunidad!‚Äù o ‚Äú¬°Ganaste un mill√≥n!‚Äù, activa tu <em>modo ninja</em> y ¬°no hagas clic! ü•∑</small></p>
      </div>
    </div>
  </div>
</div>
<div id="passwordLab">
  <div class="modal panel">
    <h2>üß™ Laboratorio de Contrase√±as: Craftea la llave</h2>
    <p>Arrastra letras, n√∫meros y s√≠mbolos a los <strong>slots</strong> para crear tu contrase√±a. Debe cumplir los requisitos.</p>
    <div id="lab">
      <div>
        <h3>Pool de Caracteres</h3>
        <div id="pool" class="drop" aria-label="Zona con piezas para arrastrar"></div>
        <div style="margin-top:8px" class="req" id="reqList">
          <div class="r bad" data-req="len">‚â• 8 caracteres</div>
          <div class="r bad" data-req="upper">May√∫scula</div>
          <div class="r bad" data-req="num">N√∫mero</div>
          <div class="r bad" data-req="sym">S√≠mbolo</div>
        </div>
      </div>
      <div>
        <h3>Tu Contrase√±a</h3>
        <div id="pwd" class="drop" aria-label="Construye tu contrase√±a aqu√≠"></div>
        <div style="margin-top:10px"><span>Vista previa: <code id="pwdPreview">(vac√≠o)</code></span></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="clearPwd">Limpiar</button>
          <button class="btn" id="submitPwd">Probar Cerradura</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="endScreen"><div class="modal panel" id="endPanel"></div></div>
<div id="controls" aria-hidden="true">
  <div class="pad blank"></div> <button class="pad" data-dx="0" data-dy="-1"><span>‚ñ≤</span></button> <div class="pad blank"></div>
  <button class="pad" data-dx="-1" data-dy="0"><span>‚óÄ</span></button> <div class="pad blank"></div> <button class="pad" data-dx="1" data-dy="0"><span>‚ñ∂</span></button>
  <div class="pad blank"></div> <button class="pad" data-dx="0" data-dy="1"><span>‚ñº</span></button> <div class="pad blank"></div>
</div>

<script>
(() => {
  const viewport = document.getElementById('viewport'); const arena = document.getElementById('arena');
  const phaseEl = document.getElementById('phase'); const scoreEl = document.getElementById('score');
  const stealthEl = document.getElementById('stealth'); const alertsEl = document.getElementById('alerts');
  const briefing = document.getElementById('briefing'); const passwordLab = document.getElementById('passwordLab');
  const endScreen = document.getElementById('endScreen'); const endPanel = document.getElementById('endPanel');
  const speakBtn = document.getElementById('speakBtn'); const restartBtn = document.getElementById('restartBtn');

  const PHISHING_PHRASES = [ "¬°Gana un celular GRATIS en segundos!", "Descarga esta app para monedas ilimitadas en tu juego.", "Un amigo quiere compartir fotos contigo, inicia sesi√≥n para verlas.", "Completa esta encuesta y recibe un premio sorpresa.", "¬°Oferta incre√≠ble! iPhones a mitad de precio solo por hoy.", "Tu paquete no se pudo entregar. Confirma tu direcci√≥n aqu√≠.", "¬°Felicidades! Has sido seleccionado para un premio exclusivo.", "¬°√öltima oportunidad para reclamar tu regalo!", ];
  const SAFE_PHRASES = [ "Consejo: ¬°Piensa antes de hacer clic!", "Agencia: Verifica siempre la fuente.", "Tip: Desconf√≠a de premios m√°gicos.", "¬°Buen trabajo! Ignoraste la trampa.", "Esa es la actitud, agente.", "El remitente era sospechoso. Bien hecho.", ];

  const S = { W: 960, H: 540, speed: 3.2, friction: 0.88 };
  const state = { phase: 'Briefing', score: 0, stealth: 100, alerts: 0, keys: {up:false,down:false,left:false,right:false}, player: {x:40,y:240,w:36,h:36, vx:0, vy:0}, movers: [], gates: [], raf: null };

  function createParticles(x, y, color, count = 10) { for (let i = 0; i < count; i++) { const p = document.createElement('div'); p.style.position = 'absolute'; p.style.left = x + 'px'; p.style.top = y + 'px'; const size = Math.random() * 5 + 2; p.style.width = size + 'px'; p.style.height = size + 'px'; p.style.background = color; p.style.borderRadius = '50%'; p.style.pointerEvents = 'none'; arena.appendChild(p); const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 3 + 1; const vx = Math.cos(angle) * speed; const vy = Math.sin(angle) * speed; let life = Math.random() * 0.5 + 0.5; function animateParticle() { p.style.left = (parseFloat(p.style.left) + vx) + 'px'; p.style.top = (parseFloat(p.style.top) + vy) + 'px'; p.style.opacity = life; life -= 0.02; if (life > 0) requestAnimationFrame(animateParticle); else p.remove(); } animateParticle(); } }
  function popElement(el) { el.classList.add('pop'); el.addEventListener('animationend', () => el.classList.remove('pop'), { once: true }); }
  function shakeScreen() { viewport.classList.add('shake'); viewport.addEventListener('animationend', () => viewport.classList.remove('shake'), { once: true }); }
  function setPhase(p){ state.phase=p; phaseEl.textContent=p; }
  function addScore(n){ state.score+=n; scoreEl.textContent=state.score; popElement(scoreEl); }
  function setStealth(n){ state.stealth=Math.max(0,Math.min(100,n)); stealthEl.textContent=state.stealth; popElement(stealthEl); }
  function addAlert(){ state.alerts++; alertsEl.textContent = state.alerts; popElement(alertsEl); shakeScreen(); viewport.style.borderColor = 'var(--danger)'; viewport.style.boxShadow = 'inset 0 0 50px rgba(255,59,59,.25)'; setTimeout(() => { viewport.style.borderColor = '#1a275f'; viewport.style.boxShadow = 'inset 0 0 50px rgba(0,229,255,.08)'; }, 300); if(state.alerts>=5) return defeat('Activaste demasiadas alarmas.'); }
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  function beep(type='sine', freq=600, ms=150, gain=0.06){ try{ if(ctx.state==='suspended') ctx.resume(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = type; o.frequency.value=freq; g.gain.value = gain; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); }, ms); }catch(e){} }
  function sfxStealth(){ beep('triangle', 520, 120, 0.05); speakLine('¬°Bien esquivado, Agente!'); }
  function sfxAlarm(){ beep('square', 220, 220, 0.08); speakLine('¬°Ese anuncio era una trampa!'); }
  function sfxLock(){ beep('sine', 820, 180, 0.06); speakLine('¬°Acceso concedido!'); }
  function sfxGenius(){ beep('sawtooth', 660, 200, 0.06); speakLine('¬°Maniobra de genio! ¬°Ignoraste el enga√±o!'); }
  function speakLine(text){ if(!window.speechSynthesis) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'es-MX'; u.rate = 1.1; u.pitch = 1; u.volume = 1; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
  document.getElementById('briefSpeak').onclick = () => speakLine('Agente, evita los anuncios trampa en rojo. Recoge los verdes para puntos. Crea contrase√±as fuertes: ocho caracteres m√≠nimo, una may√∫scula, un n√∫mero y un s√≠mbolo. ¬°Suerte!');
  speakBtn.onclick = () => speakLine('Controles con flechas o pad t√°ctil. Evita trampas rojas, toca anuncios verdes. Crea contrase√±as fuertes para abrir puertas.');
  function rect(el, x,y,w,h, cls, label){ const d = document.createElement('div'); d.className = `tile ${cls}`; d.style.left=x+'px'; d.style.top=y+'px'; d.style.width=w+'px'; d.style.height=h+'px'; if(label) d.textContent=label; el.appendChild(d); return d; }
  function aabb(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  function buildHallway(){
    setPhase('Pasillo de las Alarmas'); arena.innerHTML=''; arena.style.width=S.W+'px'; arena.style.height=S.H+'px';
    state.player = {x:20,y:S.H/2-18,w:36,h:36,vx:0,vy:0};
    const pEl = rect(arena, state.player.x, state.player.y, 36,36, 'player');
    const gate = {x:S.W-80,y:S.H/2-40,w:60,h:80};
    rect(arena, gate.x, gate.y, gate.w, gate.h, 'gate', 'üîê Cerradura'); state.gates = [gate];
    const shuffledBait = [...PHISHING_PHRASES].sort(() => 0.5 - Math.random()); const shuffledGoods = [...SAFE_PHRASES].sort(() => 0.5 - Math.random());
    state.movers = [];
    function addMover(kind, index){ const w=160,h=40; let x=200+Math.random()*(S.W-380), y=40+Math.random()*(S.H-80); const speed = (kind==='alarm'? 1.2: 1.0) + Math.random()*0.8; const dir = Math.random()<.5?1:-1; const vx = (Math.random()<.5?speed:0)*dir; const vy = (vx===0?speed:0)*(Math.random()<.5?1:-1); const label = kind==='alarm'? shuffledBait[index % shuffledBait.length] : shuffledGoods[index % shuffledGoods.length]; const el = rect(arena, x,y,w,h, kind==='alarm'?'alarm':'safe', label); state.movers.push({kind,x,y,w,h,vx,vy,el,hit:false}); }
    for(let i=0;i<6;i++) addMover('alarm', i); for(let i=0;i<3;i++) addMover('safe', i);
    for(let i=0;i<10;i++){ const y = i*54+6; const lane = rect(arena, 0,y, S.W, 2, '', ''); lane.style.background = 'linear-gradient(90deg, transparent, rgba(0,229,255,.18), transparent)';}
    function loop(){ if (state.phase !== 'Pasillo de las Alarmas') return; const p = state.player; if(state.keys.left) p.vx -= S.speed/4; if(state.keys.right) p.vx += S.speed/4; if(state.keys.up) p.vy -= S.speed/4; if(state.keys.down) p.vy += S.speed/4; p.vx *= S.friction; p.vy *= S.friction; const speedMagnitude = Math.sqrt(p.vx*p.vx + p.vy*p.vy); if (speedMagnitude > S.speed) { p.vx = (p.vx / speedMagnitude) * S.speed; p.vy = (p.vy / speedMagnitude) * S.speed; } p.x += p.vx; p.y += p.vy; p.x = Math.max(0, Math.min(S.W-p.w, p.x)); p.y = Math.max(0, Math.min(S.H-p.h, p.y)); pEl.style.transform = `translate(${p.x}px, ${p.y}px)`; pEl.style.left = '0px'; pEl.style.top = '0px'; for(const m of state.movers){ m.x += m.vx; m.y += m.vy; if(m.x<0||m.x+m.w>S.W) m.vx*=-1; if(m.y<0||m.y+m.h>S.H) m.vy*=-1; m.el.style.left=m.x+'px'; m.el.style.top=m.y+'px'; if(aabb(p,m)){ if(m.kind==='alarm' && !m.hit){ m.hit=true; m.el.style.opacity=.7; m.el.style.filter='grayscale(40%)'; createParticles(p.x + p.w/2, p.y + p.h/2, 'var(--danger)'); addAlert(); setStealth(state.stealth-18); addScore(-5); sfxAlarm(); } else if(m.kind==='safe' && !m.hit){ m.hit=true; m.el.style.transform='scale(0)'; m.el.style.opacity=0; createParticles(p.x + p.w/2, p.y + p.h/2, 'var(--accent2)'); addScore(10); sfxStealth(); } } } if(aabb(p, state.gates[0])){ cancelAnimationFrame(state.raf); openPasswordLab(); return; } state.raf = requestAnimationFrame(loop); }
    state.raf = requestAnimationFrame(loop);
  }
  function openPasswordLab(){ setPhase('Cerraduras de Contrase√±a'); passwordLab.classList.add('visible'); buildPool(); }
  function buildPool(){ const pool = document.getElementById('pool'); const pwd = document.getElementById('pwd'); const preview = document.getElementById('pwdPreview'); const reqList = document.getElementById('reqList'); pool.innerHTML=''; pwd.innerHTML=''; preview.textContent='(vac√≠o)'; const pieces = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*_-+=?'.split(''); for (let i = pieces.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [pieces[i], pieces[j]] = [pieces[j], pieces[i]]; } pieces.slice(0, 48).forEach(ch => pool.appendChild(makeToken(ch))); function makeToken(ch){ const t = document.createElement('div'); t.className='token'; t.textContent=ch; t.draggable=true; t.tabIndex=0; t.setAttribute('role','button'); t.title='Arrastra para usar'; t.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', ch); e.currentTarget.style.opacity='0.5'; }); t.addEventListener('dragend', e=>{ e.currentTarget.style.opacity='1'; }); t.addEventListener('click', ()=>{ addToPwd(ch); }); return t; } function addToPwd(ch){ const s = document.createElement('span'); s.className='slot'; s.textContent=ch; s.dataset.ch=ch; s.addEventListener('click', ()=>{ s.remove(); updatePreview(); }); pwd.appendChild(s); updatePreview(); } [pool,pwd].forEach(box=>{ box.addEventListener('dragover', e=>e.preventDefault()); box.addEventListener('drop', e=>{ e.preventDefault(); const ch = e.dataTransfer.getData('text/plain'); if(box===pwd) addToPwd(ch); }); }); document.getElementById('clearPwd').onclick = ()=>{ pwd.innerHTML=''; updatePreview(); }; document.getElementById('submitPwd').onclick = ()=>{ const pass = collect(); const ok = validate(pass); if(ok){ sfxLock(); passwordLab.classList.remove('visible'); buildFinalRoom(); } else { sfxAlarm(); shakeScreen(); } }; const collect = () => [...pwd.querySelectorAll('.slot')].map(s=>s.dataset.ch).join(''); function updatePreview(){ const pass = collect(); preview.textContent = pass || '(vac√≠o)'; validate(pass, true); } function setReq(id, good){ const el = reqList.querySelector(`[data-req="${id}"]`); const wasBad = el.classList.contains('bad'); el.classList.toggle('bad', !good); if (wasBad && !el.classList.contains('bad')) { beep('sine', 1200, 80, 0.04); } } function validate(pass, soft){ const okLen = pass.length>=8, okUpper = /[A-Z]/.test(pass), okNum = /[0-9]/.test(pass), okSym = /[!@#$%^&*_\-+=?]/.test(pass), notCommon = !/(password|admin|qwerty|abc|1234)/i.test(pass); setReq('len', okLen); setReq('upper', okUpper); setReq('num', okNum); setReq('sym', okSym); if(!soft){ addScore((okLen+okUpper+okNum+okSym+notCommon)*2); } return okLen && okUpper && okNum && okSym && notCommon; } }
  function buildFinalRoom(){
    setPhase('C√°mara del Diamante'); arena.innerHTML=''; const w=S.W, h=S.H; arena.style.width=w+'px'; arena.style.height=h+'px';
    state.player = {x:40,y:h-80,w:36,h:36,vx:0,vy:0};
    const pEl = rect(arena, state.player.x, state.player.y, 36,36, 'player');
    const msgs = [ '¬°Alerta de seguridad! Haz clic AHORA para proteger tu cuenta.', '¬°Felicidades! Ingresa tu contrase√±a para reclamar tu premio.', '¬°Tu youtuber favorito regala autos! √önete ya.', ];
    const alarms = [rect(arena, 220, 120, 220, 50, 'alarm', msgs[0]), rect(arena, 520, 320, 220, 50, 'alarm', msgs[1]), rect(arena, 340, 420, 220, 50, 'alarm', msgs[2])];
    const aBoxes = alarms.map(a => ({x:a.offsetLeft, y:a.offsetTop, w:a.offsetWidth, h:a.offsetHeight, el: a, hit: false}));
    const sw = rect(arena, w-110, 40, 70, 40, 'switch', '‚èª'); sw.title='Haz click para desactivar';
    sw.addEventListener('click', ()=>{ sfxGenius(); aBoxes.forEach(a=>{ a.el.style.opacity=.25; a.el.style.filter='grayscale(100%)'; a.el.style.textDecoration='line-through'; a.hit = true; }); addScore(50); diamond.style.display='flex'; diamond.style.transform = 'scale(1)'; sw.style.pointerEvents = 'none'; sw.style.opacity = 0.5; });
    const diamond = rect(arena, w/2-20, h/2-60, 40,40, 'diamond'); diamond.style.display='none'; diamond.style.transform = 'scale(0)'; diamond.style.transition = 'transform .5s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
    const diamondBox = {x: w/2-20, y: h/2-60, w:40,h:40};
    function loop(){ if(state.phase !== 'C√°mara del Diamante') return; const p = state.player; if(state.keys.left) p.vx -= S.speed/4; if(state.keys.right) p.vx += S.speed/4; if(state.keys.up) p.vy -= S.speed/4; if(state.keys.down) p.vy += S.speed/4; p.vx *= S.friction; p.vy *= S.friction; const speedMagnitude = Math.sqrt(p.vx*p.vx + p.vy*p.vy); if (speedMagnitude > S.speed) { p.vx = (p.vx / speedMagnitude) * S.speed; p.vy = (p.vy / speedMagnitude) * S.speed; } p.x += p.vx; p.y += p.vy; p.x = Math.max(0, Math.min(w-p.w, p.x)); p.y = Math.max(0, Math.min(h-p.h, p.y)); pEl.style.transform = `translate(${p.x}px, ${p.y}px)`; pEl.style.left = '0px'; pEl.style.top = '0px'; for(const box of aBoxes){ if(!box.hit && aabb(p, box)){ cancelAnimationFrame(state.raf); return defeat('Las S√∫per Alarmas te atraparon. Truco: ign√≥ralas y busca el interruptor.'); } } if(diamond.style.display !== 'none' && aabb(p, diamondBox)){ cancelAnimationFrame(state.raf); return victory(); } state.raf = requestAnimationFrame(loop); }
    state.raf = requestAnimationFrame(loop);
    function victory(){ endPanel.innerHTML = `<h2>üèÜ ¬°Misi√≥n cumplida, Agente!</h2><p>Recuperaste el <strong>Diamante de la Informaci√≥n</strong> y desactivaste las S√∫per Alarmas sin caer en el clickbait.</p><ul><li>Puntaje final: <strong>${state.score}</strong></li><li>Sigilo: <strong>${state.stealth}</strong></li><li>Alarmas activadas: <strong>${state.alerts}</strong></li></ul><p>Recuerda: <em>Pensar antes de hacer clic</em> y usar <strong>contrase√±as fuertes</strong> te mantiene a salvo.</p><div class="voiceRow"><button class="btn" id="playAgainBtn">Jugar de nuevo</button></div>`; endScreen.classList.add('visible'); document.getElementById('playAgainBtn').onclick = resetGame; }
  }
  function defeat(reason){ if (state.raf) cancelAnimationFrame(state.raf); endPanel.innerHTML = `<h2>üîî ¬°Capturado!</h2><p>${reason}</p><h3>Lecci√≥n de Ciberseguridad</h3><ul><li>Desconf√≠a de mensajes con prisa: ‚Äú√öltima oportunidad‚Äù busca que no pienses.</li><li>Nadie regala cosas por nada. Verifica la fuente.</li><li>Para contrase√±as fuertes: mezcla <strong>May√∫sculas</strong>, <strong>n√∫meros</strong> y <strong>s√≠mbolos</strong> y evita palabras comunes.</li></ul><div class="voiceRow"><button class="btn" id="retryBtn">Reintentar</button></div>`; endScreen.classList.add('visible'); document.getElementById('retryBtn').onclick = resetGame; sfxAlarm(); }

  /* --- MEJORA: Funci√≥n de reinicio suave --- */
  function resetGame() {
    if (state.raf) cancelAnimationFrame(state.raf);
    state.phase = 'Briefing';
    state.score = 0;
    state.stealth = 100;
    state.alerts = 0;
    state.keys = {up:false,down:false,left:false,right:false};
    state.movers = [];
    state.gates = [];

    scoreEl.textContent = state.score;
    stealthEl.textContent = state.stealth;
    alertsEl.textContent = state.alerts;
    phaseEl.textContent = state.phase;

    arena.innerHTML = '';
    endScreen.classList.remove('visible');
    passwordLab.classList.remove('visible');
    briefing.classList.add('visible');
  }

  const keyMap = {ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right','w':'up','a':'left','s':'down','d':'right'};
  window.addEventListener('keydown', e=>{ const k = keyMap[e.key]; if(k){ state.keys[k]=true; e.preventDefault(); } });
  window.addEventListener('keyup', e=>{ const k = keyMap[e.key]; if(k){ state.keys[k]=false; e.preventDefault(); } });
  document.querySelectorAll('#controls .pad').forEach(btn=>{ if(btn.classList.contains('blank')) return; const dx = parseInt(btn.dataset.dx||'0'); const dy = parseInt(btn.dataset.dy||'0'); function press(){ if(dx<0) state.keys.left=true; if(dx>0) state.keys.right=true; if(dy<0) state.keys.up=true; if(dy>0) state.keys.down=true; } function release(){ if(dx<0) state.keys.left=false; if(dx>0) state.keys.right=false; if(dy<0) state.keys.up=false; if(dy>0) state.keys.down=false; } btn.addEventListener('touchstart', e=>{ e.preventDefault(); press(); }, {passive: false}); btn.addEventListener('touchend', e=>{ e.preventDefault(); release(); }); btn.addEventListener('mousedown', e=>{ e.preventDefault(); press(); }); btn.addEventListener('mouseup', release); btn.addEventListener('mouseleave', release); });
  
  document.getElementById('startBtn').onclick = ()=>{ briefing.classList.remove('visible'); if(ctx.state === 'suspended') ctx.resume(); buildHallway(); };
  
  // --- MEJORA: Asignar la nueva funci√≥n de reinicio ---
  restartBtn.onclick = resetGame;
  briefing.classList.add('visible');
})();
</script>
</body>
</html>
