<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente Secreto: La Fortaleza del Phishing</title>
  <style>
    :root{
      --bg:#0b1020;            /* fondo oscuro futurista */
      --panel:#131b3a;         /* paneles azules */
      --accent:#00e5ff;        /* cian hologr√°fico */
      --accent2:#7cff6b;       /* verde seguro */
      --danger:#ff3b3b;        /* rojo alarma */
      --gold:#ffd54a;          /* oro del diamante */
      --text:#eaf4ff;
      --muted:#9ab3c7;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden;}
    h1,h2,h3{margin:.2rem 0}
    #game{display:grid;grid-template-rows:auto 1fr auto;gap:.5rem;height:100%;padding:10px}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#15235a,#0d1330);border:1px solid #22306b;border-radius:14px;padding:8px 12px;box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 30px rgba(0,229,255,.08)}
    .hud{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:rgba(0,229,255,.08);border:1px solid #1b2b66;border-radius:999px;padding:6px 10px;font-weight:700}
    .chip small{opacity:.8;font-weight:600}
    .chip .dot{width:10px;height:10px;border-radius:50%}
    .chip.score .dot{background:var(--accent2)}
    .chip.stealth .dot{background:#8a7cff}
    .chip.alerts .dot{background:var(--danger)}
    .btn{background:linear-gradient(180deg,#0fe,#0acfdc);color:#00131a;border:none;border-radius:999px;padding:8px 14px;font-weight:900;letter-spacing:.3px;cursor:pointer;box-shadow:0 8px 24px rgba(0,229,255,.25);transition:transform .15s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.98)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}

    #viewport{position:relative;overflow:hidden;border-radius:16px;background:radial-gradient(1200px 800px at 70% 10%, #16224f 0%, var(--bg) 60%);border:2px solid #1a275f;box-shadow:inset 0 0 50px rgba(0,229,255,.08);transition: box-shadow .2s ease, border-color .2s ease}
    #arena{position:absolute;inset:0;}

    @keyframes pulse { 0%, 100% { box-shadow: 0 0 14px rgba(0,229,255,.7); } 50% { box-shadow: 0 0 24px 4px rgba(0,229,255,1); } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    @keyframes shake { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-5px)} 20%,40%,60%,80%{transform:translateX(5px)} }
    .shake{animation:shake .3s ease-in-out;}
    .pop { display: inline-block; animation: pop .3s ease; }

    .tile{position:absolute;border-radius:8px;display:flex;align-items:center;justify-content:center;text-align:center;font-weight:800;padding:4px 6px; transition: opacity .3s ease, transform .3s ease, filter .3s ease;}
    .player{width:36px;height:36px;background:conic-gradient(from 0deg,#00e5ff,#7a7cff,#00e5ff);border:2px solid #baf3ff;border-radius:10px;animation: pulse 2.5s ease-in-out infinite; z-index: 10;}
    .player:after{content:"";position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:10px;height:10px;border-radius:50%;background:#fff}
    .alarm{background:linear-gradient(180deg,#ff7070,#ff3b3b);border:2px solid #ffb3b3;color:#2c0000;box-shadow:0 0 18px rgba(255,59,59,.75); z-index: 5;}
    .safe{background:linear-gradient(180deg,#b7ffb0,#59ff48);border:2px solid #e1ffe0;color:#083300;box-shadow:0 0 18px rgba(124,255,107,.7); z-index: 5;}
    .alarm,.safe{padding:6px 8px;font-size:12px; line-height: 1.2;}
    .gate{background:linear-gradient(180deg,#0d8a9b,#064b53);border:2px dashed #4beaff;color:#bff7ff}
    .switch{background:linear-gradient(180deg,#ffe27a,#ffc300);border:2px solid #fff1a3;color:#3b2d00;box-shadow:0 0 18px rgba(255,213,74,.6); cursor:pointer; z-index: 4;}
    .diamond{background:radial-gradient(circle at 20% 20%, #fff, #a8f3ff 40%, #00e5ff 70%, transparent 71%), linear-gradient(135deg,#e1fbff,#00e5ff);border:2px solid #bdf4ff;box-shadow:0 0 22px rgba(0,229,255,.9);width:40px;height:40px;border-radius:8px; z-index: 6;}

    .panel{background:linear-gradient(180deg,#17265d,#0e173a);border:1px solid #263882;border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.45), inset 0 0 40px rgba(0,229,255,.06);padding:16px}
    #briefing,#passwordLab,#endScreen{position:fixed;inset:0;background:rgba(7,10,25,.85);display:flex;align-items:center;justify-content:center;z-index:15;opacity:0;visibility:hidden;transition:opacity .4s ease, visibility .4s ease;}
    #briefing.visible, #passwordLab.visible, #endScreen.visible { opacity:1; visibility:visible; }
    #briefing.visible .modal, #passwordLab.visible .modal, #endScreen.visible .modal { transform: scale(1) translateY(0); }
    .modal{max-width:980px;width:clamp(320px,92vw,980px);transform: scale(0.95) translateY(20px); transition: transform .4s ease;}
    .jefa{display:flex;gap:14px;align-items:flex-start}
    .avatar{min-width:72px;height:72px;border-radius:16px;background:conic-gradient(from 220deg,#00e5ff,#7cff6b,#00e5ff);box-shadow:0 4px 16px rgba(0,229,255,.4);position:relative}
    .avatar:after{content:"üéß";position:absolute;right:-6px;top:-10px;font-size:28px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.6))}
    .voiceRow{display:flex;gap:8px;align-items:center;margin-top:6px}

    #lab{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    #pool,.drop{min-height:220px;border:2px dashed #2c4bd6;border-radius:12px;padding:10px;background:rgba(0,229,255,.06)}
    #pool{display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}
    .token{user-select:none;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:linear-gradient(180deg,#20336f,#17265d);border:1px solid #2d4bd2;box-shadow:0 6px 14px rgba(0,0,0,.35);font-weight:900;cursor:grab;transition:transform .2s ease, box-shadow .2s ease}
    .token:active{cursor:grabbing;transform:scale(1.15);box-shadow:0 8px 20px rgba(0,0,0,.5);}
    .slot{display:inline-flex;min-width:30px;height:38px;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,.06);border:1px dashed #3b58da;margin:2px;padding:2px 6px;animation: pop 0.2s ease-out;}
    .req{display:flex;flex-wrap:wrap;gap:6px}
    .req .r{padding:6px 8px;border-radius:999px;background:rgba(124,255,107,.1);border:1px solid rgba(124,255,107,.4);font-size:12px;transition:background .3s, border-color .3s}
    .req .bad{background:rgba(255,59,59,.12);border-color:rgba(255,59,59,.4)}

    #controls{position:fixed;left:10px;bottom:10px;z-index:12;display:grid;grid-template-columns:60px 60px 60px;grid-template-rows:60px 60px 60px;gap:6px;opacity:.9}
    .pad{background:linear-gradient(180deg,#22346b,#1a275f);border:1px solid #2b3f84;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 12px 24px rgba(0,0,0,.35);-webkit-tap-highlight-color: transparent;}
    .pad:active{transform:translateY(2px)}
    .pad span{font-size:18px}
    .pad.blank{background:transparent;border:none;box-shadow:none}

    footer{display:flex;gap:10px;align-items:center;justify-content:space-between;opacity:.9}
    footer small{color:var(--muted)}
    .sr{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
<div id="game">
  <header>
    <div class="hud">
      <div class="chip score" id="scoreChip"><div class="dot"></div><span>Puntos: <span id="score">0</span></span></div>
      <div class="chip stealth" id="stealthChip"><div class="dot"></div><span>Sigilo: <span id="stealth">100</span></span></div>
      <div class="chip alerts" id="alertsChip"><div class="dot"></div><span>Alarmas: <span id="alerts">0</span>/5</span></div>
      <div class="chip"><span>Fase: <strong id="phase">Briefing</strong></span></div>
    </div>
    <div class="hud">
      <button class="btn" id="speakBtn" title="Voz en off">üîä Voz</button>
      <button class="btn" id="restartBtn" title="Reiniciar">‚Üª Reiniciar</button>
    </div>
  </header>
  <main id="viewport" class="panel" aria-live="polite"><div id="arena"></div></main>
  <footer>
    <div><strong>Controles:</strong> Flechas / WASD o pad t√°ctil. Toca/Click en puertas/interruptores.</div>
    <small>Agente Secreto: La Fortaleza del Phishing ‚Äî 3¬∞ Primaria</small>
  </footer>
</div>

<div id="briefing">
  <div class="modal panel">
    <h2>üî∑ BRIEFING: Operaci√≥n ‚ÄúDiamante de la Informaci√≥n‚Äù</h2>
    <div class="jefa">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <p><strong>Jefa de la Agencia:</strong> ¬°Atenci√≥n, Agente! La Fortaleza est√° llena de <span style="color:var(--danger);font-weight:900">Alarmas de Clickbait</span>. Son trampas que prometen premios falsos.</p>
        <p>Tu misi√≥n:
        <ol>
          <li>Esquiva los anuncios rojos (l√°seres).</li>
          <li>Recoge anuncios seguros (verdes).</li>
          <li>Forja contrase√±as fuertes (May√∫scula, n√∫mero, s√≠mbolo, +8 caracteres).</li>
          <li>Infiltrate en la c√°mara final y desactiva las S√∫per Alarmas.</li>
        </ol>
        <div class="voiceRow">
          <button class="btn" id="startBtn">¬°Aceptar Misi√≥n!</button>
          <button class="btn" id="briefSpeak">üîä Escuchar Misi√≥n</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="passwordLab">
  <div class="modal panel">
    <h2>üß™ Laboratorio de Contrase√±as</h2>
    <p>La puerta est√° cerrada. Arrastra los ingredientes para crear una llave maestra.</p>
    <div id="lab">
      <div>
        <h3>Ingredientes</h3>
        <div id="pool" class="drop"></div>
        <div style="margin-top:8px" class="req" id="reqList">
          <div class="r bad" data-req="len">8+ Letras</div>
          <div class="r bad" data-req="upper">ABC (May√∫s)</div>
          <div class="r bad" data-req="num">123 (N√∫m)</div>
          <div class="r bad" data-req="sym">@#$ (S√≠mbolo)</div>
        </div>
      </div>
      <div>
        <h3>Tu Llave</h3>
        <div id="pwd" class="drop"></div>
        <div style="margin-top:10px"><span>Previsualizaci√≥n: <code id="pwdPreview" style="color:var(--accent)">(vac√≠o)</code></span></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="clearPwd" style="background:var(--panel);border:1px solid #fff">Borrar</button>
          <button class="btn" id="submitPwd">HACKEAR PUERTA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="endScreen"><div class="modal panel" id="endPanel"></div></div>

<div id="controls" aria-hidden="true">
  <div class="pad blank"></div> <button class="pad" data-dx="0" data-dy="-1"><span>‚ñ≤</span></button> <div class="pad blank"></div>
  <button class="pad" data-dx="-1" data-dy="0"><span>‚óÄ</span></button> <div class="pad blank"></div> <button class="pad" data-dx="1" data-dy="0"><span>‚ñ∂</span></button>
  <div class="pad blank"></div> <button class="pad" data-dx="0" data-dy="1"><span>‚ñº</span></button> <div class="pad blank"></div>
</div>

<script>
(() => {
  const viewport = document.getElementById('viewport'); const arena = document.getElementById('arena');
  const phaseEl = document.getElementById('phase'); const scoreEl = document.getElementById('score');
  const stealthEl = document.getElementById('stealth'); const alertsEl = document.getElementById('alerts');
  const briefing = document.getElementById('briefing'); const passwordLab = document.getElementById('passwordLab');
  const endScreen = document.getElementById('endScreen'); const endPanel = document.getElementById('endPanel');
  const speakBtn = document.getElementById('speakBtn'); const restartBtn = document.getElementById('restartBtn');

  // Frases de juego
  const PHISHING_PHRASES = [ "¬°Gana un iPhone GRATIS!", "¬°Tu cuenta ser√° BORRADA!", "¬°Mira qui√©n vio tu perfil!", "¬°Premio sorpresa aqu√≠!", "¬°Oferta 99% descuento!", "¬°Error de seguridad!", "¬°Fuiste seleccionado!", "¬°Reclama tu regalo ya!" ];
  const SAFE_PHRASES = [ "Agencia: Verifica el link", "Tip: No des datos", "Seguro: Fuente confiable", "Agencia: Buen ojo", "Tip: Contrase√±a fuerte" ];
  
  // Configuraci√≥n
  const S = { W: 960, H: 540, speed: 3.5, friction: 0.88 };
  const state = { phase: 'Briefing', score: 0, stealth: 100, alerts: 0, keys: {up:false,down:false,left:false,right:false}, player: {x:40,y:240,w:36,h:36, vx:0, vy:0}, movers: [], gates: [], raf: null };

  // Utilidades gr√°ficas y de audio
  function createParticles(x, y, color, count = 10) { for (let i = 0; i < count; i++) { const p = document.createElement('div'); p.style.position = 'absolute'; p.style.left = x + 'px'; p.style.top = y + 'px'; const size = Math.random() * 5 + 2; p.style.width = size + 'px'; p.style.height = size + 'px'; p.style.background = color; p.style.borderRadius = '50%'; p.style.pointerEvents = 'none'; p.style.zIndex = 20; arena.appendChild(p); const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 3 + 1; const vx = Math.cos(angle) * speed; const vy = Math.sin(angle) * speed; let life = Math.random() * 0.5 + 0.5; function animateParticle() { p.style.left = (parseFloat(p.style.left) + vx) + 'px'; p.style.top = (parseFloat(p.style.top) + vy) + 'px'; p.style.opacity = life; life -= 0.05; if (life > 0) requestAnimationFrame(animateParticle); else p.remove(); } animateParticle(); } }
  function popElement(el) { el.classList.remove('pop'); void el.offsetWidth; el.classList.add('pop'); }
  function shakeScreen() { viewport.classList.remove('shake'); void viewport.offsetWidth; viewport.classList.add('shake'); }
  function setPhase(p){ state.phase=p; phaseEl.textContent=p; }
  function addScore(n){ state.score+=n; scoreEl.textContent=state.score; popElement(scoreEl); }
  function setStealth(n){ state.stealth=Math.max(0,Math.min(100,n)); stealthEl.textContent=state.stealth; popElement(stealthEl); }
  function addAlert(){ state.alerts++; alertsEl.textContent = state.alerts; popElement(alertsEl); shakeScreen(); viewport.style.borderColor = 'var(--danger)'; viewport.style.boxShadow = 'inset 0 0 50px rgba(255,59,59,.25)'; setTimeout(() => { viewport.style.borderColor = '#1a275f'; viewport.style.boxShadow = 'inset 0 0 50px rgba(0,229,255,.08)'; }, 300); if(state.alerts>=5) return defeat('¬°Demasiadas alarmas activadas! Los Robadatos te han localizado.'); }
  
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  function beep(type='sine', freq=600, ms=150, gain=0.06){ try{ if(ctx.state==='suspended') ctx.resume(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = type; o.frequency.value=freq; g.gain.value = gain; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); }, ms); }catch(e){} }
  function sfxStealth(){ beep('triangle', 520, 120, 0.05); }
  function sfxAlarm(){ beep('sawtooth', 180, 250, 0.08); }
  function sfxLock(){ beep('sine', 820, 180, 0.06); }
  function sfxGenius(){ beep('square', 660, 200, 0.06); }
  function speakLine(text){ if(!window.speechSynthesis) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'es-MX'; u.rate = 1.1; window.speechSynthesis.speak(u); }
  
  document.getElementById('briefSpeak').onclick = () => speakLine('Agente, la fortaleza est√° llena de trampas. Esquiva lo rojo, busca lo verde y crea contrase√±as seguras para ganar.');
  speakBtn.onclick = () => speakLine('Usa las flechas para moverte. No toques los anuncios rojos. Toca el interruptor para desactivar las alarmas.');
  
  function rect(el, x,y,w,h, cls, label){ const d = document.createElement('div'); d.className = `tile ${cls}`; d.style.left=x+'px'; d.style.top=y+'px'; d.style.width=w+'px'; d.style.height=h+'px'; if(label) d.textContent=label; el.appendChild(d); return d; }
  function aabb(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

  /* --- FASE 1: PASILLO --- */
  function buildHallway(){
    setPhase('Pasillo de Infiltraci√≥n'); arena.innerHTML=''; 
    // Ajustar l√≠mites
    S.W = viewport.clientWidth; S.H = viewport.clientHeight;
    
    state.player = {x:30,y:S.H/2-18,w:36,h:36,vx:0,vy:0};
    const pEl = rect(arena, state.player.x, state.player.y, 36,36, 'player');
    
    const gate = {x:S.W-80,y:S.H/2-40,w:60,h:80};
    rect(arena, gate.x, gate.y, gate.w, gate.h, 'gate', 'Cerradura'); state.gates = [gate];
    
    state.movers = [];
    const shuffledBait = [...PHISHING_PHRASES].sort(() => 0.5 - Math.random());
    const shuffledSafe = [...SAFE_PHRASES].sort(() => 0.5 - Math.random());
    
    function addMover(kind, i){
       const w = 150, h = 45;
       let x = 100 + Math.random()*(S.W-300);
       let y = 20 + Math.random()*(S.H-80);
       const speed = (kind==='alarm'?1.5:1) + Math.random();
       const vx = (Math.random()<.5?1:-1)*speed;
       const vy = (Math.random()<.5?1:-1)*speed * 0.5;
       const txt = kind==='alarm'? shuffledBait[i%shuffledBait.length] : shuffledSafe[i%shuffledSafe.length];
       const el = rect(arena, x,y,w,h, kind==='alarm'?'alarm':'safe', txt);
       state.movers.push({kind,x,y,w,h,vx,vy,el,hit:false});
    }
    for(let i=0;i<7;i++) addMover('alarm', i);
    for(let i=0;i<3;i++) addMover('safe', i);

    function loop(){
      if(state.phase!=='Pasillo de Infiltraci√≥n') return;
      updatePlayer(pEl);
      // Mover enemigos fase 1
      state.movers.forEach(m => {
        m.x += m.vx; m.y += m.vy;
        if(m.x<=0 || m.x+m.w>=S.W) m.vx*=-1;
        if(m.y<=0 || m.y+m.h>=S.H) m.vy*=-1;
        m.el.style.left = m.x+'px'; m.el.style.top = m.y+'px';
        
        if(aabb(state.player, m)){
          if(m.kind==='alarm' && !m.hit){
             m.hit=true; m.el.style.opacity=0.5; m.el.style.filter='grayscale(1)';
             addAlert(); sfxAlarm(); createParticles(state.player.x, state.player.y, 'red');
             addScore(-5); setStealth(state.stealth-15);
          } else if(m.kind==='safe' && !m.hit){
             m.hit=true; m.el.style.transform='scale(0)';
             addScore(15); sfxStealth(); createParticles(state.player.x, state.player.y, '#0f0');
          }
        }
      });
      // Salida
      if(aabb(state.player, state.gates[0])){ cancelAnimationFrame(state.raf); openPasswordLab(); return; }
      state.raf = requestAnimationFrame(loop);
    }
    state.raf = requestAnimationFrame(loop);
  }

  /* --- LOGICA DEL JUGADOR COM√öN --- */
  function updatePlayer(el){
    const p = state.player;
    if(state.keys.left) p.vx -= S.speed/4;
    if(state.keys.right) p.vx += S.speed/4;
    if(state.keys.up) p.vy -= S.speed/4;
    if(state.keys.down) p.vy += S.speed/4;
    p.vx *= S.friction; p.vy *= S.friction;
    p.x += p.vx; p.y += p.vy;
    // Limites
    p.x = Math.max(0, Math.min(S.W-p.w, p.x));
    p.y = Math.max(0, Math.min(S.H-p.h, p.y));
    el.style.transform = `translate(${p.x}px, ${p.y}px)`;
    el.style.left=0; el.style.top=0;
  }

  /* --- MINIJUEGO CONTRASE√ëA --- */
  function openPasswordLab(){ setPhase('Hackeo de Seguridad'); passwordLab.classList.add('visible'); buildPool(); }
  function buildPool(){
    const pool=document.getElementById('pool'), pwd=document.getElementById('pwd'), pre=document.getElementById('pwdPreview');
    pool.innerHTML=''; pwd.innerHTML=''; pre.textContent='(vac√≠o)';
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&*?'.split('').sort(()=>.5-Math.random()).slice(0,40);
    chars.forEach(c => {
      const t = document.createElement('div'); t.className='token'; t.textContent=c; t.draggable=true;
      t.onclick = () => addChar(c);
      t.ondragstart = e => e.dataTransfer.setData('text',c);
      pool.appendChild(t);
    });
    const addChar = (c) => {
      const s = document.createElement('span'); s.className='slot'; s.textContent=c; s.dataset.c=c;
      s.onclick = () => { s.remove(); checkPwd(); };
      pwd.appendChild(s); checkPwd();
    };
    pwd.ondragover = e => e.preventDefault();
    pwd.ondrop = e => { e.preventDefault(); addChar(e.dataTransfer.getData('text')); };
    
    document.getElementById('clearPwd').onclick = () => { pwd.innerHTML=''; checkPwd(); };
    
    function checkPwd(final=false){
      const txt = [...pwd.children].map(x=>x.dataset.c).join('');
      pre.textContent = txt || '(vac√≠o)';
      const okL = txt.length>=8, okU = /[A-Z]/.test(txt), okN = /[0-9]/.test(txt), okS = /[!@#$%&*?]/.test(txt);
      document.querySelector('[data-req="len"]').classList.toggle('bad', !okL);
      document.querySelector('[data-req="upper"]').classList.toggle('bad', !okU);
      document.querySelector('[data-req="num"]').classList.toggle('bad', !okN);
      document.querySelector('[data-req="sym"]').classList.toggle('bad', !okS);
      return okL && okU && okN && okS;
    }
    
    document.getElementById('submitPwd').onclick = () => {
      if(checkPwd()){ 
        sfxLock(); addScore(50); speakLine('¬°Acceso concedido! Contrase√±a segura.');
        passwordLab.classList.remove('visible'); buildFinalRoom();
      } else { 
        sfxAlarm(); shakeScreen(); speakLine('Error. La contrase√±a no cumple los requisitos.');
      }
    };
  }

  /* --- FASE 2: C√ÅMARA DEL DIAMANTE (CORREGIDA) --- */
  function buildFinalRoom(){
    setPhase('C√°mara del Diamante'); arena.innerHTML='';
    S.W = viewport.clientWidth; S.H = viewport.clientHeight;
    
    // Jugador inicia abajo
    state.player = {x: S.W/2 - 20, y: S.H - 60, w:36, h:36, vx:0, vy:0};
    const pEl = rect(arena, state.player.x, state.player.y, 36,36, 'player');

    // Diamante en el centro (oculto/protegido)
    const diamond = rect(arena, S.W/2-20, S.H/2-40, 40,40, 'diamond');
    diamond.style.opacity = '0.3'; // Se ve apagado hasta desactivar alarmas
    const diamondBox = {x:S.W/2-20, y:S.H/2-40, w:40, h:40};

    // Interruptor para desactivar alarmas (esquina superior aleatoria)
    const swX = Math.random() > 0.5 ? 20 : S.W - 90;
    const sw = rect(arena, swX, 30, 70, 40, 'switch', 'APAGAR');
    const switchBox = {x:swX, y:30, w:70, h:40};
    
    let alarmsActive = true;

    // Crear "S√∫per Alarmas" (Enemigos m√≥viles)
    const superMsgs = [
      "¬°Felicidades! Ganaste un Auto", 
      "¬°ALERTA! Tu cuenta fue hackeada", 
      "¬°Click Aqu√≠ para Protegerte!",
      "¬°Regalo Exclusivo de Youtuber!" 
    ];
    
    const enemies = [];
    superMsgs.forEach((msg, i) => {
       const w = 200, h = 50;
       // Posici√≥n inicial aleatoria en la mitad superior
       const ex = Math.random() * (S.W - w);
       const ey = Math.random() * (S.H/2); 
       const el = rect(arena, ex, ey, w, h, 'alarm', msg);
       el.style.zIndex = 10;
       el.style.boxShadow = '0 0 25px var(--danger)';
       // Velocidad m√°s alta para el reto final
       enemies.push({
         x:ex, y:ey, w:w, h:h, 
         vx: (Math.random()<.5?2:-2) * (1.2 + Math.random()), 
         vy: (Math.random()<.5?2:-2) * (1.2 + Math.random()), 
         el:el
       });
    });

    // Evento del interruptor
    sw.addEventListener('click', disableAlarms);
    sw.addEventListener('touchstart', (e)=>{e.preventDefault(); disableAlarms();});

    function disableAlarms(){
       if(!alarmsActive) return;
       alarmsActive = false;
       sfxGenius(); speakLine('¬°Sistema de trampas desactivado! Ve por el diamante.');
       sw.style.opacity = 0.5; sw.textContent = "OFF";
       sw.style.background = "#555";
       diamond.style.opacity = '1'; diamond.style.boxShadow = "0 0 40px var(--accent)";
       addScore(100);
       
       // Detener visualmente a los enemigos
       enemies.forEach(e => {
         e.el.style.opacity = 0.2;
         e.el.style.filter = "grayscale(100%)";
         e.el.style.textDecoration = "line-through";
       });
    }

    function loop(){
      if(state.phase !== 'C√°mara del Diamante') return;
      
      updatePlayer(pEl);
      
      // L√≥gica de enemigos
      enemies.forEach(en => {
        if(alarmsActive) {
          // Solo se mueven si las alarmas est√°n activas
          en.x += en.vx; en.y += en.vy;
          // Rebote
          if(en.x <= 0 || en.x + en.w >= S.W) en.vx *= -1;
          if(en.y <= 0 || en.y + en.h >= S.H) en.vy *= -1;
          
          en.el.style.left = en.x + 'px';
          en.el.style.top = en.y + 'px';
          
          // Colisi√≥n con jugador (DERROTA INMEDIATA si activo)
          if(aabb(state.player, en)){
            defeat("¬°Ca√≠ste en la S√∫per Trampa! Nunca conf√≠es en premios urgentes.");
            return;
          }
        }
      });

      // Chequear si toc√≥ el interruptor f√≠sicamente (opcional aparte del click)
      if(alarmsActive && aabb(state.player, switchBox)){
         // Opcional: permitir activarlo toc√°ndolo
         // disableAlarms(); 
      }

      // Chequear victoria (tocar diamante)
      if(!alarmsActive && aabb(state.player, diamondBox)){
         victory();
         return; 
      }
      
      state.raf = requestAnimationFrame(loop);
    }
    state.raf = requestAnimationFrame(loop);
  }

  /* --- FINALIZACI√ìN --- */
  function victory(){
    cancelAnimationFrame(state.raf);
    endPanel.innerHTML = `
      <h2>üèÜ ¬°Misi√≥n Cumplida!</h2>
      <p>Has recuperado el <strong>Diamante de la Informaci√≥n</strong>.</p>
      <div style="display:flex;justify-content:space-around;margin:20px 0;background:rgba(255,255,255,0.1);padding:10px;border-radius:10px">
        <div style="text-align:center"><span>Puntos</span><br><strong style="font-size:1.5em;color:var(--gold)">${state.score}</strong></div>
        <div style="text-align:center"><span>Sigilo</span><br><strong style="font-size:1.5em;color:#fff">${state.stealth}%</strong></div>
      </div>
      <p>Aprendizaje: Ignoraste el clickbait y usaste contrase√±as fuertes. ¬°Eres un Agente Maestro!</p>
      <button class="btn" id="replayBtn">Jugar Otra Vez</button>
    `;
    endScreen.classList.add('visible');
    sfxStealth();
    document.getElementById('replayBtn').onclick = resetGame;
  }

  function defeat(msg){
    cancelAnimationFrame(state.raf);
    endPanel.innerHTML = `
      <h2 style="color:var(--danger)">‚õî ¬°Atrapado!</h2>
      <p>${msg}</p>
      <p>Los Robadatos te han llevado al aula de repaso.</p>
      <button class="btn" id="retryBtn">Intentar de Nuevo</button>
    `;
    endScreen.classList.add('visible');
    sfxAlarm();
    document.getElementById('retryBtn').onclick = resetGame;
  }

  function resetGame(){
    cancelAnimationFrame(state.raf);
    state.score=0; state.stealth=100; state.alerts=0;
    scoreEl.textContent='0'; stealthEl.textContent='100'; alertsEl.textContent='0';
    endScreen.classList.remove('visible');
    briefing.classList.add('visible');
  }

  // Inputs
  const keys = state.keys;
  window.onkeydown = e => {
    if(e.key==='ArrowUp'||e.key==='w') keys.up=true;
    if(e.key==='ArrowDown'||e.key==='s') keys.down=true;
    if(e.key==='ArrowLeft'||e.key==='a') keys.left=true;
    if(e.key==='ArrowRight'||e.key==='d') keys.right=true;
  };
  window.onkeyup = e => {
    if(e.key==='ArrowUp'||e.key==='w') keys.up=false;
    if(e.key==='ArrowDown'||e.key==='s') keys.down=false;
    if(e.key==='ArrowLeft'||e.key==='a') keys.left=false;
    if(e.key==='ArrowRight'||e.key==='d') keys.right=false;
  };
  // Touch pad
  document.querySelectorAll('.pad').forEach(b=>{
    if(b.classList.contains('blank'))return;
    const dx= +b.dataset.dx, dy= +b.dataset.dy;
    b.ontouchstart = e => { e.preventDefault(); if(dx<0)keys.left=true; if(dx>0)keys.right=true; if(dy<0)keys.up=true; if(dy>0)keys.down=true; };
    b.ontouchend = e => { e.preventDefault(); keys.left=keys.right=keys.up=keys.down=false; };
    b.onmousedown = e => { if(dx<0)keys.left=true; if(dx>0)keys.right=true; if(dy<0)keys.up=true; if(dy>0)keys.down=true; };
    b.onmouseup = b.onmouseleave = () => { keys.left=keys.right=keys.up=keys.down=false; };
  });

  document.getElementById('startBtn').onclick = () => {
    briefing.classList.remove('visible');
    if(ctx.state==='suspended') ctx.resume();
    buildHallway();
  };
  document.getElementById('restartBtn').onclick = resetGame;
  
  // Auto ajuste de tama√±o al girar pantalla
  window.addEventListener('resize', ()=>{
    S.W = viewport.clientWidth; S.H = viewport.clientHeight;
  });

  briefing.classList.add('visible');

})();
</script>
</body>
</html>
